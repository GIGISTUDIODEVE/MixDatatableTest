<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ë¡œê·¸ì¸</title>
  <style>
    :root{
      --bg:#0b0e14; --panel:#121826; --panel2:#0f1420; --text:#e6e8ee; --muted:#9aa3b2;
      --line:rgba(255,255,255,.08); --primary:#4f7cff; --danger:#ff5a67; --ok:#3ddc97;
      --shadow:0 18px 50px rgba(0,0,0,.35);
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
      background:radial-gradient(1200px 700px at 15% 0%, rgba(79,124,255,.18), transparent 60%), var(--bg);
      color:var(--text);
    }
    .wrap{max-width:980px;margin:48px auto;padding:0 16px;}
    .card{
      background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      border:1px solid var(--line);
      border-radius:18px;
      overflow:hidden;
      box-shadow:var(--shadow);
    }
    .head{display:flex;gap:12px;align-items:center;padding:18px 20px;border-bottom:1px solid var(--line); background:rgba(0,0,0,.18)}
    .dot{width:10px;height:10px;border-radius:99px;background:var(--primary); box-shadow:0 0 0 6px rgba(79,124,255,.18)}
    .head h1{font-size:16px;margin:0}
    .grid{display:grid;grid-template-columns:1.05fr .95fr}
    @media (max-width:900px){.grid{grid-template-columns:1fr}}
    .left,.right{padding:18px 20px}
    .left{border-right:1px solid var(--line)}
    @media (max-width:900px){.left{border-right:none;border-bottom:1px solid var(--line)}}
    .section{padding:14px;border:1px solid var(--line);border-radius:14px;background:rgba(0,0,0,.16); margin-bottom:14px}
    .section h2{font-size:14px;margin:0 0 10px 0}
    .row{display:grid;gap:10px}
    .field label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px}
    input{
      width:100%;
      padding:12px 12px;
      border-radius:12px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.03);
      color:var(--text);
      outline:none;
    }
    input:disabled{opacity:.55;cursor:not-allowed}
    .actions{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
    button{
      border:1px solid var(--line);
      background:rgba(255,255,255,.04);
      color:var(--text);
      padding:10px 12px;
      border-radius:12px;
      cursor:pointer;
    }
    button.primary{background:rgba(79,124,255,.18);border-color:rgba(79,124,255,.35)}
    button.danger{background:rgba(255,90,103,.12);border-color:rgba(255,90,103,.35)}
    button:disabled{opacity:.5;cursor:not-allowed}
    .status{margin-top:12px;font-size:13px;color:var(--muted);line-height:1.45}
    .pill{display:inline-flex;align-items:center;gap:8px;border:1px solid var(--line);padding:7px 10px;border-radius:999px;background:rgba(255,255,255,.03);font-size:12px;color:var(--muted)}
    .pill b{color:var(--text);font-weight:600}
    .ok{color:var(--ok)}
    .bad{color:var(--danger)}
    .hint{font-size:12px;color:var(--muted);margin-top:6px}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace}

    /* ===== Modal ===== */
    .overlay{
      position:fixed; inset:0;
      background:rgba(0,0,0,.6);
      display:none;
      align-items:center;
      justify-content:center;
      padding:18px;
      z-index:1000;
    }
    .overlay.open{display:flex}
    .modal{
      width:min(760px, 100%);
      background:linear-gradient(180deg, rgba(18,24,38,.98), rgba(15,20,32,.95));
      border:1px solid var(--line);
      border-radius:18px;
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    .modal-head{
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      padding:16px 18px;border-bottom:1px solid var(--line); background:rgba(0,0,0,.18)
    }
    .modal-head h3{margin:0;font-size:14px}
    .icon-btn{
      width:36px;height:36px;border-radius:12px;display:grid;place-items:center;
      background:rgba(255,255,255,.04);
    }
    .modal-body{padding:16px 18px}
    .two{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media (max-width:720px){.two{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="head">
        <div class="dot"></div>
        <h1>ë¡œê·¸ì¸</h1>
      </div>

      <div class="grid">
        <div class="left">
          <div class="section">
            <h2>ì´ë©”ì¼/ë¹„ë°€ë²ˆí˜¸ ë¡œê·¸ì¸</h2>
            <div class="row">
              <div class="field">
                <label for="login-email">ì´ë©”ì¼</label>
                <input id="login-email" type="email" autocomplete="email" placeholder="name@example.com"/>
              </div>
              <div class="field">
                <label for="login-pw">ë¹„ë°€ë²ˆí˜¸</label>
                <input id="login-pw" type="password" autocomplete="current-password" placeholder="ë¹„ë°€ë²ˆí˜¸"/>
              </div>

              <div class="actions">
                <button id="login" class="primary" type="button">ë¡œê·¸ì¸</button>
                <button id="open-signup" type="button">íšŒì›ê°€ì…</button>
              </div>
              <div class="hint">
                * íšŒì›ê°€ì…ì€ íŒì—…ì—ì„œ ì§„í–‰í•©ë‹ˆë‹¤. ê°€ì… í›„ <b>ì´ë©”ì¼ ì¸ì¦</b>ì„ ì™„ë£Œí•´ì•¼ â€œì¸ì¦ë¨â€ ìƒíƒœê°€ ë©ë‹ˆë‹¤.
              </div>

              <div class="status" id="login-status" aria-live="polite"></div>
            </div>
          </div>

          <div class="section">
            <h2>ë¡œê·¸ì¸ í›„ ë™ì‘</h2>
            <div class="row">
              <div class="actions">
                <button id="resend-verify" type="button" disabled>ì¸ì¦ë©”ì¼ ì¬ì „ì†¡</button>
                <button id="check-verified" class="primary" type="button" disabled>ì¸ì¦ ì™„ë£Œ í™•ì¸</button>
                <button id="logout" class="danger" type="button" disabled>ë¡œê·¸ì•„ì›ƒ</button>
              </div>
              <div class="status" id="after-status" aria-live="polite"></div>
              <div class="hint">
                ì¸ì¦ë©”ì¼ ì¬ì „ì†¡ì€ ìŠ¤íŒ¸/ê³¼ë‹¤ìš”ì²­ ë°©ì§€ë¥¼ ìœ„í•´ <b>ì¿¨ë‹¤ìš´</b>ì´ ìˆìŠµë‹ˆë‹¤.
              </div>
            </div>
          </div>
        </div>

        <div class="right">
          <div class="section">
            <h2>í˜„ì¬ ìƒíƒœ</h2>
            <div class="row">
              <div class="pill">ë¡œê·¸ì¸: <b id="auth-pill">-</b></div>
              <div class="pill">ì´ë©”ì¼ ì¸ì¦: <b id="verified-pill">-</b></div>
              <div class="pill">ì¬ì „ì†¡ ì¿¨ë‹¤ìš´: <b id="cooldown-pill" class="mono">-</b></div>
            </div>
            <div class="status" id="global-status" aria-live="polite"></div>
          </div>

          <div class="section">
            <h2>ì½˜ì†” ì„¤ì • ì²´í¬ë¦¬ìŠ¤íŠ¸</h2>
            <div class="status">
              <div>1) Authentication â†’ <b>Sign-in method</b> â†’ <b>Email/Password</b> í™œì„±í™”</div>
              <div>2) Authentication â†’ <b>Templates</b> â†’ â€œì´ë©”ì¼ ì£¼ì†Œ ì¸ì¦â€ í…œí”Œë¦¿ í¸ì§‘</div>
              <div>3) Authentication â†’ <b>Settings</b> â†’ <b>Authorized domains</b>ì— ì‚¬ìš©í•˜ëŠ” ë„ë©”ì¸ ì¶”ê°€</div>
              <div class="hint">â€» <span class="mono">auth/operation-not-allowed</span>ëŠ” ëŒ€ê°œ 1) ì œê³µì ë¹„í™œì„±í™” ë•Œë¬¸ì— ë°œìƒí•©ë‹ˆë‹¤.</div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ===== Signup Modal ===== -->
  <div class="overlay" id="signup-overlay" role="dialog" aria-modal="true" aria-labelledby="signup-title">
    <div class="modal">
      <div class="modal-head">
        <h3 id="signup-title">íšŒì›ê°€ì…</h3>
        <button class="icon-btn" id="close-signup" type="button" aria-label="ë‹«ê¸°">âœ•</button>
      </div>
      <div class="modal-body">
        <div class="section">
          <h2>ê³„ì • ìƒì„± + ì¸ì¦ë©”ì¼ ì „ì†¡</h2>
          <div class="row">
            <div class="two">
              <div class="field">
                <label for="su-email">ì´ë©”ì¼</label>
                <input id="su-email" type="email" autocomplete="email" placeholder="name@example.com"/>
              </div>
              <div class="field">
                <label for="su-pw">ë¹„ë°€ë²ˆí˜¸</label>
                <input id="su-pw" type="password" autocomplete="new-password" placeholder="ìµœì†Œ 6ì"/>
              </div>
            </div>
            <div class="field">
              <label for="su-pw2">ë¹„ë°€ë²ˆí˜¸ í™•ì¸</label>
              <input id="su-pw2" type="password" autocomplete="new-password" placeholder="ë¹„ë°€ë²ˆí˜¸ë¥¼ í•œ ë²ˆ ë” ì…ë ¥"/>
            </div>

            <div class="actions">
              <button id="create-and-send" class="primary" type="button">ê³„ì • ìƒì„± &amp; ì¸ì¦ë©”ì¼ ì „ì†¡</button>
              <button id="su-resend" type="button" disabled>ì¸ì¦ë©”ì¼ ì¬ì „ì†¡</button>
              <button id="su-check" class="primary" type="button" disabled>ì¸ì¦ ì™„ë£Œ í™•ì¸</button>
            </div>

            <div class="hint">
              * Firebase ê¸°ë³¸ â€œì´ë©”ì¼ ì£¼ì†Œ ì¸ì¦â€ í…œí”Œë¦¿ì„ ì“°ë ¤ë©´ ê³„ì •ì„ ë¨¼ì € ë§Œë“¤ì–´ì•¼ í•´ì„œ ë¹„ë°€ë²ˆí˜¸ ì…ë ¥ì´ ì„ í–‰ë©ë‹ˆë‹¤.
            </div>
            <div class="status" id="su-status" aria-live="polite"></div>
          </div>
        </div>

        <div class="section">
          <h2>ê°€ì… ì™„ë£Œ</h2>
          <div class="status" id="su-done" aria-live="polite">
            ë©”ì¼ ì¸ì¦ì´ ì™„ë£Œë˜ë©´ â€œê°€ì… ì™„ë£Œâ€ë¡œ í‘œì‹œë©ë‹ˆë‹¤.
          </div>
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
    import {
      getAuth,
      createUserWithEmailAndPassword,
      signInWithEmailAndPassword,
      sendEmailVerification,
      reload,
      signOut,
      onAuthStateChanged,
    } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";
    import { getFirebaseConfig } from "./firebase-config.js";

    const $ = (id) => document.getElementById(id);

    // Login DOM
    const loginEmailEl = $("login-email");
    const loginPwEl = $("login-pw");
    const loginBtn = $("login");
    const openSignupBtn = $("open-signup");
    const loginStatus = $("login-status");

    const resendVerifyBtn = $("resend-verify");
    const checkVerifiedBtn = $("check-verified");
    const logoutBtn = $("logout");
    const afterStatus = $("after-status");

    // Status DOM
    const authPill = $("auth-pill");
    const verifiedPill = $("verified-pill");
    const cooldownPill = $("cooldown-pill");
    const globalStatus = $("global-status");

    // Signup modal DOM
    const overlay = $("signup-overlay");
    const closeSignupBtn = $("close-signup");
    const suEmailEl = $("su-email");
    const suPwEl = $("su-pw");
    const suPw2El = $("su-pw2");
    const createSendBtn = $("create-and-send");
    const suResendBtn = $("su-resend");
    const suCheckBtn = $("su-check");
    const suStatus = $("su-status");
    const suDone = $("su-done");

    // ===== INIT =====
    const app = initializeApp(getFirebaseConfig());
    const auth = getAuth(app);

    // ===== Helpers =====
    function setText(el, msg, tone="info"){
      el.innerHTML = msg || "";
      el.style.color = tone==="bad" ? "var(--danger)" : tone==="ok" ? "var(--ok)" : "var(--muted)";
    }
    function setPills(){
      const u = auth.currentUser;
      authPill.textContent = u ? "ON" : "OFF";
      verifiedPill.textContent = u ? (u.emailVerified ? "YES" : "NO") : "-";
    }

    // ===== COOLDOWN (too-many-requests ë°©ì§€) =====
    const COOLDOWN_KEY = "verify_email_last_send_at";
    const DEFAULT_COOLDOWN = 60;
    let cooldownTimer = null;
    let cooldownSeconds = DEFAULT_COOLDOWN;

    const fmt = (s) => {
      const m = String(Math.floor(s/60)).padStart(2,"0");
      const r = String(s%60).padStart(2,"0");
      return `${m}:${r}`;
    };

    function canResendNow(){
      return cooldownPill.textContent === "0:00" || cooldownPill.textContent === "-" || cooldownPill.textContent === "0:00";
    }

    function startCooldown(seconds){
      clearInterval(cooldownTimer);
      const startedAt = Date.now();
      localStorage.setItem(COOLDOWN_KEY, String(startedAt));
      cooldownSeconds = seconds;

      cooldownPill.textContent = fmt(seconds);

      // disable resend buttons while cooling
      resendVerifyBtn.disabled = true;
      suResendBtn.disabled = true;

      cooldownTimer = setInterval(() => {
        const elapsed = Math.floor((Date.now() - startedAt)/1000);
        const left = Math.max(0, cooldownSeconds - elapsed);
        cooldownPill.textContent = left ? fmt(left) : "0:00";

        if(left <= 0){
          clearInterval(cooldownTimer);
          // enable if logged-in and NOT verified
          const u = auth.currentUser;
          const allow = !!u && !u.emailVerified;
          resendVerifyBtn.disabled = !allow;
          suResendBtn.disabled = !allow;
        }
      }, 250);
    }

    function resumeCooldownIfAny(){
      const last = Number(localStorage.getItem(COOLDOWN_KEY) || "0");
      if(!last) { cooldownPill.textContent = "-"; return; }
      const elapsed = Math.floor((Date.now() - last)/1000);
      const left = Math.max(0, cooldownSeconds - elapsed);
      if(left > 0) startCooldown(left);
      else cooldownPill.textContent = "0:00";
    }

    // ===== Signup modal open/close =====
    function openSignup(){
      overlay.classList.add("open");
      // prefill email from login if present
      const le = loginEmailEl.value.trim();
      if(le && !suEmailEl.value.trim()) suEmailEl.value = le;
      suEmailEl.focus();
    }
    function closeSignup(){
      overlay.classList.remove("open");
    }
    overlay.addEventListener("click", (e) => {
      if(e.target === overlay) closeSignup();
    });
    window.addEventListener("keydown", (e) => {
      if(e.key === "Escape" && overlay.classList.contains("open")) closeSignup();
    });

    openSignupBtn.addEventListener("click", openSignup);
    closeSignupBtn.addEventListener("click", closeSignup);

    // ===== Validation =====
    function validateSignupInputs(){
      const email = suEmailEl.value.trim();
      const pw = suPwEl.value;
      const pw2 = suPw2El.value;

      if(!email) return {ok:false, msg:"ì´ë©”ì¼ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”."};
      if(!pw || pw.length < 6) return {ok:false, msg:"ë¹„ë°€ë²ˆí˜¸ëŠ” ìµœì†Œ 6ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤."};
      if(pw !== pw2) return {ok:false, msg:"ë¹„ë°€ë²ˆí˜¸ í™•ì¸ì´ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤."};
      return {ok:true, email, pw};
    }

    // ===== Core =====
    async function sendVerifyEmail(user){
      await sendEmailVerification(user);
    }

    async function handleLogin(){
      const email = loginEmailEl.value.trim();
      const pw = loginPwEl.value;

      if(!email){ setText(loginStatus, "ì´ë©”ì¼ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”.", "bad"); return; }
      if(!pw){ setText(loginStatus, "ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”.", "bad"); return; }

      loginBtn.disabled = true;
      try{
        await signInWithEmailAndPassword(auth, email, pw);
        setText(loginStatus, "ë¡œê·¸ì¸ ì„±ê³µ âœ…", "ok");
      }catch(e){
        const code = e?.code || "";
        if(code === "auth/invalid-credential" || code === "auth/wrong-password"){
          setText(loginStatus, "ì´ë©”ì¼/ë¹„ë°€ë²ˆí˜¸ë¥¼ í™•ì¸í•´ ì£¼ì„¸ìš”.", "bad");
        }else if(code === "auth/user-not-found"){
          setText(loginStatus, "ê°€ì…ëœ ê³„ì •ì´ ì—†ì–´ìš”. íšŒì›ê°€ì…ì„ ì§„í–‰í•´ ì£¼ì„¸ìš”.", "bad");
        }else if(code === "auth/too-many-requests"){
          setText(loginStatus, "ìš”ì²­ì´ ë„ˆë¬´ ë§ì•„ ì ì‹œ ì°¨ë‹¨ëì–´ìš”. ì ì‹œ ë’¤ ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.", "bad");
        }else{
          setText(loginStatus, `ë¡œê·¸ì¸ ì‹¤íŒ¨: ${code || e?.message || e}`, "bad");
        }
      }finally{
        loginBtn.disabled = false;
      }
    }

    async function handleCreateAndSend(){
      const v = validateSignupInputs();
      if(!v.ok){ setText(suStatus, v.msg, "bad"); return; }

      createSendBtn.disabled = true;

      try{
        const cred = await createUserWithEmailAndPassword(auth, v.email, v.pw);
        await sendVerifyEmail(cred.user);

        setText(suStatus, "ì¸ì¦ë©”ì¼ì„ ë³´ëƒˆì–´ìš”. ë©”ì¼ì—ì„œ ë§í¬ë¥¼ í´ë¦­í•œ ë’¤ â€œì¸ì¦ ì™„ë£Œ í™•ì¸â€ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.", "ok");
        setText(suDone, "ëŒ€ê¸° ì¤‘â€¦ (ì´ë©”ì¼ ì¸ì¦ í•„ìš”)", "info");

        // enable modal actions
        suCheckBtn.disabled = false;
        // start cooldown (resend stays disabled until cooldown end)
        startCooldown(DEFAULT_COOLDOWN);
        setPills();

      }catch(e){
        const code = e?.code || "";
        if(code === "auth/email-already-in-use"){
          setText(suStatus, "ì´ë¯¸ ê°€ì…ëœ ì´ë©”ì¼ì´ì—ìš”. íŒì—…ì„ ë‹«ê³  ë¡œê·¸ì¸ í›„ â€˜ì¸ì¦ë©”ì¼ ì¬ì „ì†¡â€™ì„ ì‚¬ìš©í•´ ì£¼ì„¸ìš”.", "bad");
        }else if(code === "auth/operation-not-allowed"){
          setText(suStatus, "auth/operation-not-allowed: ì½˜ì†”ì—ì„œ Email/Password ì œê³µìê°€ êº¼ì ¸ìˆì„ ê°€ëŠ¥ì„±ì´ ë†’ì•„ìš”. ìš°ì¸¡ ì²´í¬ë¦¬ìŠ¤íŠ¸ 1ë²ˆì„ í™•ì¸í•´ ì£¼ì„¸ìš”.", "bad");
        }else if(code === "auth/too-many-requests"){
          setText(suStatus, "ìš”ì²­ì´ ë„ˆë¬´ ë§ì•„ ì ì‹œ ì°¨ë‹¨ëì–´ìš”. 5ë¶„ ë’¤ ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.", "bad");
          startCooldown(300);
        }else{
          setText(suStatus, `ì—ëŸ¬: ${code || e?.message || e}`, "bad");
        }
      }finally{
        createSendBtn.disabled = false;
        setPills();
      }
    }

    async function handleResend(){
      const u = auth.currentUser;
      if(!u){
        setText(afterStatus, "ì¬ì „ì†¡í•˜ë ¤ë©´ ë¨¼ì € ë¡œê·¸ì¸ ìƒíƒœì—¬ì•¼ í•´ìš”.", "bad");
        setText(suStatus, "ì¬ì „ì†¡í•˜ë ¤ë©´ ë¨¼ì € ë¡œê·¸ì¸ ìƒíƒœì—¬ì•¼ í•´ìš”.", "bad");
        return;
      }
      if(u.emailVerified){
        setText(afterStatus, "ì´ë¯¸ ì¸ì¦ëœ ê³„ì •ì´ì—ìš”.", "ok");
        setText(suStatus, "ì´ë¯¸ ì¸ì¦ëœ ê³„ì •ì´ì—ìš”.", "ok");
        return;
      }

      resendVerifyBtn.disabled = true;
      suResendBtn.disabled = true;

      try{
        await sendVerifyEmail(u);
        setText(globalStatus, "ì¸ì¦ë©”ì¼ì„ ë‹¤ì‹œ ë³´ëƒˆì–´ìš”.", "ok");
        setText(afterStatus, "ì¸ì¦ë©”ì¼ì„ ë‹¤ì‹œ ë³´ëƒˆì–´ìš”.", "ok");
        setText(suStatus, "ì¸ì¦ë©”ì¼ì„ ë‹¤ì‹œ ë³´ëƒˆì–´ìš”.", "ok");
        startCooldown(DEFAULT_COOLDOWN);
      }catch(e){
        const code = e?.code || "";
        if(code === "auth/too-many-requests"){
          setText(globalStatus, "ìš”ì²­ì´ ë„ˆë¬´ ë§ì•„ ì ì‹œ ì°¨ë‹¨ëì–´ìš”. 5ë¶„ ë’¤ ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.", "bad");
          startCooldown(300);
        }else if(code === "auth/operation-not-allowed"){
          setText(globalStatus, "auth/operation-not-allowed: ì½˜ì†”ì—ì„œ Email/Password ì œê³µìê°€ êº¼ì ¸ìˆì„ ê°€ëŠ¥ì„±ì´ ë†’ì•„ìš”.", "bad");
        }else{
          setText(globalStatus, `ì¬ì „ì†¡ ì‹¤íŒ¨: ${code || e?.message || e}`, "bad");
        }
      }finally{
        setPills();
      }
    }

    async function handleCheckVerified(){
      const u = auth.currentUser;
      if(!u){
        setText(afterStatus, "í˜„ì¬ ë¡œê·¸ì¸ ìƒíƒœê°€ ì•„ë‹ˆì—ìš”.", "bad");
        setText(suStatus, "í˜„ì¬ ë¡œê·¸ì¸ ìƒíƒœê°€ ì•„ë‹ˆì—ìš”.", "bad");
        return;
      }
      try{
        await reload(u);
        if(u.emailVerified){
          setText(afterStatus, "ì´ë©”ì¼ ì¸ì¦ ì™„ë£Œ âœ…", "ok");
          setText(globalStatus, "ì´ë©”ì¼ ì¸ì¦ ì™„ë£Œ âœ…", "ok");
          setText(suStatus, "ì´ë©”ì¼ ì¸ì¦ ì™„ë£Œ âœ…", "ok");
          setText(suDone, "ê°€ì… ì™„ë£Œ ğŸ‰", "ok");
          closeSignup();
        }else{
          setText(afterStatus, "ì•„ì§ ì¸ì¦ì´ ì™„ë£Œë˜ì§€ ì•Šì•˜ì–´ìš”. ë©”ì¼ì˜ ë§í¬ë¥¼ í´ë¦­í–ˆëŠ”ì§€ í™•ì¸í•´ ì£¼ì„¸ìš”.", "bad");
          setText(suStatus, "ì•„ì§ ì¸ì¦ì´ ì™„ë£Œë˜ì§€ ì•Šì•˜ì–´ìš”. ë©”ì¼ì˜ ë§í¬ë¥¼ í´ë¦­í–ˆëŠ”ì§€ í™•ì¸í•´ ì£¼ì„¸ìš”.", "bad");
          setText(suDone, "ëŒ€ê¸° ì¤‘â€¦ (ì´ë©”ì¼ ì¸ì¦ í•„ìš”)", "info");
        }
      }catch(e){
        setText(afterStatus, `í™•ì¸ ì‹¤íŒ¨: ${e?.code || e?.message || e}`, "bad");
        setText(suStatus, `í™•ì¸ ì‹¤íŒ¨: ${e?.code || e?.message || e}`, "bad");
      }finally{
        setPills();
        // if cooldown ended, allow resend for unverified users
        const allow = !!auth.currentUser && !auth.currentUser.emailVerified && cooldownPill.textContent === "0:00";
        resendVerifyBtn.disabled = !allow;
        suResendBtn.disabled = !allow;
      }
    }

    async function handleLogout(){
      await signOut(auth);
      setText(loginStatus, "");
      setText(afterStatus, "ë¡œê·¸ì•„ì›ƒí–ˆì–´ìš”.", "info");
      setText(globalStatus, "ë¡œê·¸ì•„ì›ƒí–ˆì–´ìš”.", "info");
      setText(suStatus, "");
      setText(suDone, "ë©”ì¼ ì¸ì¦ì´ ì™„ë£Œë˜ë©´ â€œê°€ì… ì™„ë£Œâ€ë¡œ í‘œì‹œë©ë‹ˆë‹¤.", "info");

      // disable buttons
      resendVerifyBtn.disabled = true;
      checkVerifiedBtn.disabled = true;
      logoutBtn.disabled = true;

      suResendBtn.disabled = true;
      suCheckBtn.disabled = true;

      setPills();
    }

    // ===== Wire up =====
    loginBtn.addEventListener("click", handleLogin);
    createSendBtn.addEventListener("click", handleCreateAndSend);

    resendVerifyBtn.addEventListener("click", handleResend);
    suResendBtn.addEventListener("click", handleResend);

    checkVerifiedBtn.addEventListener("click", handleCheckVerified);
    suCheckBtn.addEventListener("click", handleCheckVerified);

    logoutBtn.addEventListener("click", handleLogout);

    // ===== Auth state sync =====
    function syncUI(){
      const u = auth.currentUser;
      setPills();

      const signedIn = !!u;
      const verified = !!u && !!u.emailVerified;

      checkVerifiedBtn.disabled = !signedIn;
      logoutBtn.disabled = !signedIn;

      suCheckBtn.disabled = !signedIn;

      // resend allowed only if signed in, not verified, and cooldown ended
      const allowResend = signedIn && !verified && cooldownPill.textContent === "0:00";
      resendVerifyBtn.disabled = !allowResend;
      suResendBtn.disabled = !allowResend;

      if(!signedIn){
        setText(globalStatus, "ë¡œê·¸ì¸í•˜ë©´ ì¸ì¦ ìƒíƒœë¥¼ í™•ì¸í•  ìˆ˜ ìˆì–´ìš”.", "info");
      }else if(verified){
        setText(globalStatus, "í˜„ì¬ ê³„ì •ì€ ì´ë©”ì¼ ì¸ì¦ì´ ì™„ë£Œëœ ìƒíƒœì…ë‹ˆë‹¤.", "ok");
      }else{
        setText(globalStatus, "ì´ë©”ì¼ ì¸ì¦ì´ ì•„ì§ ì™„ë£Œë˜ì§€ ì•Šì•˜ì–´ìš”. í•„ìš”í•˜ë©´ ì¸ì¦ë©”ì¼ì„ ì¬ì „ì†¡í•  ìˆ˜ ìˆì–´ìš”.", "info");
      }
    }

    onAuthStateChanged(auth, () => syncUI());

    // Init UI
    resumeCooldownIfAny();
    setPills();
    syncUI();
  </script>
</body>
</html>
