<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Firebase Email Verify Auth</title>
  <style>
    body{font-family:system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin:24px; max-width:720px;}
    .card{border:1px solid #ddd; border-radius:12px; padding:16px; margin:12px 0;}
    .row{display:flex; gap:8px; flex-wrap:wrap; align-items:center;}
    input{padding:10px; border:1px solid #ccc; border-radius:10px; min-width:220px;}
    button{padding:10px 12px; border:0; border-radius:10px; cursor:pointer;}
    button.primary{background:#111; color:#fff;}
    button.ghost{background:#f2f2f2;}
    .muted{color:#666; font-size:14px;}
    .error{color:#c00; white-space:pre-wrap;}
    .ok{color:#0a7; white-space:pre-wrap;}
    dialog{border:0; border-radius:14px; padding:0; width:min(520px, 92vw);}
    dialog::backdrop{background:rgba(0,0,0,.35)}
    .modal{padding:16px;}
    .modal header{display:flex; justify-content:space-between; align-items:center;}
    pre{background:#fafafa; padding:12px; border-radius:10px; overflow:auto;}
  </style>
</head>
<body>

<h1>로그인</h1>
<p class="muted">이메일 인증(emailVerified) 완료 후에만 Firestore status=active로 활성화</p>

<div class="card">
  <h2>로그인</h2>
  <div class="row">
    <input id="loginEmail" type="email" placeholder="이메일" />
    <input id="loginPw" type="password" placeholder="비밀번호" />
  </div>
  <div class="row" style="margin-top:10px;">
    <button class="primary" id="btnLogin">로그인</button>
    <button class="ghost" id="btnOpenSignup">회원가입</button>
    <button class="ghost" id="btnReset">비밀번호 재설정</button>
    <button class="ghost" id="btnLogout" style="display:none;">로그아웃</button>
  </div>
  <p id="msg" class="muted"></p>
  <p id="err" class="error"></p>
  <p id="ok" class="ok"></p>
</div>

<div class="card" id="verifyCard" style="display:none;">
  <h2>이메일 인증 필요</h2>
  <p class="muted">메일(스팸함 포함)에서 인증 완료 후 아래 버튼으로 확인해라.</p>
  <div class="row">
    <button class="primary" id="btnCheckVerified">인증 확인하기</button>
    <button class="ghost" id="btnResend">인증메일 재전송(60초 제한)</button>
  </div>
  <p id="verifyInfo" class="muted"></p>
</div>

<div class="card" id="appCard" style="display:none;">
  <h2>앱 영역</h2>
  <p class="muted">status=active 사용자만 표시</p>
  <pre id="profile"></pre>
</div>

<!-- 회원가입 모달 -->
<dialog id="signupDialog">
  <div class="modal">
    <header>
      <h2>회원가입</h2>
      <button class="ghost" id="btnCloseSignup">닫기</button>
    </header>

    <div class="row">
      <input id="suEmail" type="email" placeholder="이메일" />
      <input id="suName" type="text" placeholder="닉네임" />
    </div>
    <div class="row" style="margin-top:8px;">
      <input id="suPw" type="password" placeholder="비밀번호(최소 6자)" />
      <input id="suPw2" type="password" placeholder="비밀번호 확인" />
    </div>

    <div class="row" style="margin-top:12px;">
      <button class="primary" id="btnSignup">가입 + 인증메일 발송</button>
    </div>

    <p class="muted">가입 직후 status=pending. 이메일 인증 후 active로 바뀜.</p>
    <p id="suErr" class="error"></p>
    <p id="suOk" class="ok"></p>
  </div>
</dialog>

<script type="module">
  // 1) ✅ 본인 Firebase 설정으로 교체
  const firebaseConfig = {
    apiKey: "YOUR_API_KEY",
    authDomain: "YOUR_PROJECT.firebaseapp.com",
    projectId: "YOUR_PROJECT_ID",
    appId: "YOUR_APP_ID",
  };

  // 2) Firebase SDK (모듈)
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
  import {
    getAuth, onAuthStateChanged,
    createUserWithEmailAndPassword, signInWithEmailAndPassword,
    sendEmailVerification, sendPasswordResetEmail, signOut
  } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";

  import {
    getFirestore, doc, setDoc, getDoc, updateDoc, serverTimestamp
  } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  // --- UI helpers ---
  const $ = (id) => document.getElementById(id);
  const show = (id, on) => $(id).style.display = on ? "" : "none";
  const setText = (id, t) => $(id).textContent = t || "";
  const ok  = (t) => { setText("ok", t); setText("err", ""); };
  const err = (t) => { setText("err", t); setText("ok", ""); };
  const msg = (t) => { setText("msg", t); };

  // --- Firestore 프로필 (유저정보) ---
  async function ensureProfile(user, displayName = "") {
    const ref = doc(db, "users", user.uid);
    const snap = await getDoc(ref);
    if (!snap.exists()) {
      await setDoc(ref, {
        uid: user.uid,
        email: user.email,
        displayName,
        status: "pending",        // 인증 전
        emailVerified: false,
        createdAt: serverTimestamp(),
        updatedAt: serverTimestamp(),
        verificationSentAt: serverTimestamp(),
      });
    }
  }

  async function updateLoginTimestamps(uid) {
    await updateDoc(doc(db, "users", uid), {
      lastLoginAt: serverTimestamp(),
      updatedAt: serverTimestamp(),
    });
  }

  async function loadProfile(uid) {
    const snap = await getDoc(doc(db, "users", uid));
    return snap.exists() ? snap.data() : null;
  }

  // --- 인증 후 활성화(MVP: 클라 업데이트) ---
  async function activateIfVerified(user) {
    await user.reload();
    if (!user.emailVerified) return false;

    await updateDoc(doc(db, "users", user.uid), {
      status: "active",
      emailVerified: true,
      activatedAt: serverTimestamp(),
      updatedAt: serverTimestamp(),
    });
    return true;
  }

  // --- 재전송 60초 제한 ---
  async function canResend(uid) {
    const data = await loadProfile(uid);
    const last = data?.verificationSentAt?.toMillis?.() || 0;
    return (Date.now() - last) >= 60_000;
  }

  async function markVerificationSent(uid) {
    await updateDoc(doc(db, "users", uid), {
      verificationSentAt: serverTimestamp(),
      updatedAt: serverTimestamp(),
    });
  }

  // --- Auth state 변화 감지 ---
  onAuthStateChanged(auth, async (user) => {
    show("btnLogout", !!user);
    show("appCard", false);
    show("verifyCard", false);
    setText("profile", "");

    if (!user) {
      msg("로그인 필요");
      return;
    }

    msg(`로그인됨: ${user.email}`);
    await ensureProfile(user);
    await updateLoginTimestamps(user.uid);

    await user.reload();

    if (!user.emailVerified) {
      show("verifyCard", true);
      setText("verifyInfo", "인증 완료 후 ‘인증 확인하기’를 눌러 active로 전환됩니다.");
      return;
    }

    // 인증은 됐는데 status가 pending일 수 있어 active로 맞춤
    await activateIfVerified(user);
    const profile = await loadProfile(user.uid);

    if (profile?.status === "active") {
      show("appCard", true);
      setText("profile", JSON.stringify(profile, null, 2));
      ok("활성화 완료(status=active)");
    } else {
      show("verifyCard", true);
      err("인증은 됐는데 활성화 실패. 규칙/권한 확인 필요");
    }
  });

  // --- 이벤트: 로그인 ---
  $("btnLogin").onclick = async () => {
    err(""); ok("");
    try {
      const email = $("loginEmail").value.trim();
      const pw = $("loginPw").value;
      if (!email || !pw) throw new Error("이메일/비밀번호 입력 필요");
      await signInWithEmailAndPassword(auth, email, pw);
      ok("로그인 성공");
    } catch (e) {
      err(e?.message || String(e));
    }
  };

  // --- 이벤트: 로그아웃 ---
  $("btnLogout").onclick = async () => {
    await signOut(auth);
    ok("로그아웃됨");
  };

  // --- 이벤트: 비밀번호 재설정 ---
  $("btnReset").onclick = async () => {
    err(""); ok("");
    try {
      const email = $("loginEmail").value.trim();
      if (!email) throw new Error("이메일 입력 후 재설정 버튼을 눌러라");
      await sendPasswordResetEmail(auth, email);
      ok("비밀번호 재설정 메일 발송 완료");
    } catch (e) {
      err(e?.message || String(e));
    }
  };

  // --- 회원가입 모달 ---
  $("btnOpenSignup").onclick = () => {
    setText("suErr", ""); setText("suOk", "");
    $("signupDialog").showModal();
  };
  $("btnCloseSignup").onclick = () => $("signupDialog").close();

  // --- 이벤트: 회원가입 + 인증메일 ---
  $("btnSignup").onclick = async () => {
    setText("suErr", ""); setText("suOk", "");
    try {
      const email = $("suEmail").value.trim();
      const name  = $("suName").value.trim();
      const pw1   = $("suPw").value;
      const pw2   = $("suPw2").value;

      if (!email || !pw1) throw new Error("이메일/비밀번호 입력 필요");
      if (pw1.length < 6) throw new Error("비밀번호는 최소 6자");
      if (pw1 !== pw2) throw new Error("비밀번호 확인 불일치");

      const cred = await createUserWithEmailAndPassword(auth, email, pw1);
      const user = cred.user;

      await ensureProfile(user, name);
      await sendEmailVerification(user);
      await markVerificationSent(user.uid);

      setText("suOk", "가입 완료 + 인증메일 발송됨. 메일 인증 후 ‘인증 확인하기’ 누르세요.");
    } catch (e) {
      setText("suErr", e?.message || String(e));
    }
  };

  // --- 이벤트: 인증 확인하기 ---
  $("btnCheckVerified").onclick = async () => {
    err(""); ok("");
    const user = auth.currentUser;
    if (!user) return err("로그인 상태가 아님");

    const activated = await activateIfVerified(user);
    if (!activated) return err("아직 emailVerified=false. 메일 인증 먼저 하세요.");

    const profile = await loadProfile(user.uid);
    show("verifyCard", false);
    show("appCard", true);
    setText("profile", JSON.stringify(profile, null, 2));
    ok("인증 확인 완료 → 활성화됨(status=active)");
  };

  // --- 이벤트: 인증메일 재전송 ---
  $("btnResend").onclick = async () => {
    err(""); ok("");
    const user = auth.currentUser;
    if (!user) return err("로그인 상태가 아님");

    if (!(await canResend(user.uid))) {
      return err("재전송은 60초 후 가능");
    }

    await sendEmailVerification(user);
    await markVerificationSent(user.uid);
    ok("인증메일 재발송 완료");
  };
</script>

</body>
</html>
