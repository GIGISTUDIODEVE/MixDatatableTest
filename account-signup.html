<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>íšŒì›ê°€ì…</title>
  <style>
    :root{
      --bg:#0b0e14; --panel:#121826; --panel2:#0f1420; --text:#e6e8ee; --muted:#9aa3b2;
      --line:rgba(255,255,255,.08); --primary:#4f7cff; --danger:#ff5a67; --ok:#3ddc97;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:radial-gradient(1200px 700px at 15% 0%, rgba(79,124,255,.18), transparent 60%), var(--bg); color:var(--text);}
    .wrap{max-width:980px;margin:48px auto;padding:0 16px;}
    .card{background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02)); border:1px solid var(--line); border-radius:18px; overflow:hidden; box-shadow:0 18px 50px rgba(0,0,0,.35);}
    .head{display:flex;gap:12px;align-items:center;padding:18px 20px;border-bottom:1px solid var(--line); background:rgba(0,0,0,.18)}
    .dot{width:10px;height:10px;border-radius:99px;background:var(--primary); box-shadow:0 0 0 6px rgba(79,124,255,.18)}
    .head h1{font-size:16px;margin:0}
    .grid{display:grid;grid-template-columns:1.1fr .9fr}
    @media (max-width:900px){.grid{grid-template-columns:1fr}}
    .left,.right{padding:18px 20px}
    .left{border-right:1px solid var(--line)}
    @media (max-width:900px){.left{border-right:none;border-bottom:1px solid var(--line)}}
    .section{padding:14px;border:1px solid var(--line);border-radius:14px;background:rgba(0,0,0,.16); margin-bottom:14px}
    .section h2{font-size:14px;margin:0 0 10px 0}
    .row{display:grid;gap:10px}
    .field label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px}
    input{width:100%;padding:12px 12px;border-radius:12px;border:1px solid var(--line);background:rgba(255,255,255,.03);color:var(--text);outline:none}
    input:disabled{opacity:.55;cursor:not-allowed}
    .actions{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
    button{border:1px solid var(--line);background:rgba(255,255,255,.04);color:var(--text);padding:10px 12px;border-radius:12px;cursor:pointer}
    button.primary{background:rgba(79,124,255,.18);border-color:rgba(79,124,255,.35)}
    button:disabled{opacity:.5;cursor:not-allowed}
    .status{margin-top:12px;font-size:13px;color:var(--muted);line-height:1.4}
    .pill{display:inline-flex;align-items:center;gap:8px;border:1px solid var(--line);padding:7px 10px;border-radius:999px;background:rgba(255,255,255,.03);font-size:12px;color:var(--muted)}
    .pill b{color:var(--text);font-weight:600}
    .ok{color:var(--ok)}
    .bad{color:var(--danger)}
    .hint{font-size:12px;color:var(--muted);margin-top:6px}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="head">
        <div class="dot"></div>
        <h1>íšŒì›ê°€ì…</h1>
      </div>

      <div class="grid">
        <div class="left">
          <div class="section">
            <h2>1) ê³„ì • ìƒì„±</h2>
            <div class="row">
              <div class="field">
                <label for="email">ì´ë©”ì¼</label>
                <input id="email" type="email" autocomplete="email" placeholder="name@example.com"/>
              </div>
              <div class="field">
                <label for="pw">ë¹„ë°€ë²ˆí˜¸</label>
                <input id="pw" type="password" autocomplete="new-password" placeholder="ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”"/>
              </div>
              <div class="field">
                <label for="pw2">ë¹„ë°€ë²ˆí˜¸ í™•ì¸</label>
                <input id="pw2" type="password" autocomplete="new-password" placeholder="ë¹„ë°€ë²ˆí˜¸ë¥¼ í•œ ë²ˆ ë” ì…ë ¥í•˜ì„¸ìš”"/>
              </div>

              <div class="actions">
                <button id="create-and-send" class="primary" type="button">ê³„ì • ìƒì„± &amp; ì¸ì¦ë©”ì¼ ì „ì†¡</button>
                <button id="resend" type="button" disabled>ì¸ì¦ë©”ì¼ ì¬ì „ì†¡</button>
              </div>
              <div class="hint">
                * Firebase ê¸°ë³¸ â€œì´ë©”ì¼ ì£¼ì†Œ ì¸ì¦â€ í…œí”Œë¦¿(ì½˜ì†”ì˜ í…œí”Œë¦¿ í™”ë©´)ì„ ì‚¬ìš©í•˜ë ¤ë©´, <b>ê³„ì •ì´ ë¨¼ì € ë§Œë“¤ì–´ì ¸ì•¼</b> í•´ì„œ ë¹„ë°€ë²ˆí˜¸ ì…ë ¥ì€ ì„ í–‰ë©ë‹ˆë‹¤.
              </div>
            </div>
          </div>

          <div class="section">
            <h2>2) ì´ë©”ì¼ ì¸ì¦ ì™„ë£Œ í™•ì¸</h2>
            <div class="row">
              <div class="actions">
                <button id="check-verified" class="primary" type="button" disabled>ì¸ì¦ ì™„ë£Œ í™•ì¸</button>
                <button id="sign-out" type="button" disabled>ë¡œê·¸ì•„ì›ƒ</button>
              </div>
              <div class="status" id="verify-status" aria-live="polite"></div>
            </div>
          </div>

          <div class="section">
            <h2>3) ê°€ì… ì™„ë£Œ</h2>
            <div class="status" id="done-status" aria-live="polite">ì´ë©”ì¼ ì¸ì¦ì´ ì™„ë£Œë˜ë©´ ìë™ìœ¼ë¡œ â€œê°€ì… ì™„ë£Œâ€ ìƒíƒœê°€ ë©ë‹ˆë‹¤.</div>
          </div>
        </div>

        <div class="right">
          <div class="section">
            <h2>í˜„ì¬ ìƒíƒœ</h2>
            <div class="row">
              <div class="pill">ë¡œê·¸ì¸: <b id="auth-pill">-</b></div>
              <div class="pill">ì´ë©”ì¼ ì¸ì¦: <b id="verified-pill">-</b></div>
              <div class="pill">ì¬ì „ì†¡ ì¿¨ë‹¤ìš´: <b id="cooldown-pill" class="mono">-</b></div>
            </div>
            <div class="status" id="global-status" aria-live="polite"></div>
          </div>

          <div class="section">
            <h2>ì½˜ì†” ì„¤ì • ì²´í¬ë¦¬ìŠ¤íŠ¸</h2>
            <div class="status">
              <div>1) Authentication â†’ <b>Sign-in method</b> â†’ <b>Email/Password</b> í™œì„±í™”</div>
              <div>2) Authentication â†’ <b>Templates</b> â†’ â€œì´ë©”ì¼ ì£¼ì†Œ ì¸ì¦â€ í…œí”Œë¦¿ í¸ì§‘(í˜„ì¬ ìŠ¤í¬ë¦°ìƒ· í™”ë©´)</div>
              <div>3) Authentication â†’ <b>Settings</b> â†’ <b>Authorized domains</b>ì— ì‚¬ìš©í•˜ëŠ” ë„ë©”ì¸ ì¶”ê°€</div>
              <div class="hint">â€» ì§€ê¸ˆ ëœ¬ <span class="mono">auth/operation-not-allowed</span>ëŠ” ëŒ€ê°œ 1) ì œê³µì ë¹„í™œì„±í™” ë•Œë¬¸ì— ë°œìƒí•©ë‹ˆë‹¤.</div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
      import {
        getAuth,
        createUserWithEmailAndPassword,
        signInWithEmailAndPassword,
        sendEmailVerification,
        reload,
        signOut,
      } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";
      import { getFirebaseConfig } from "./firebase-config.js";

      const $ = (id) => document.getElementById(id);

      const emailEl = $("email");
      const pwEl = $("pw");
      const pw2El = $("pw2");

      const createSendBtn = $("create-and-send");
      const resendBtn = $("resend");
      const checkBtn = $("check-verified");
      const signOutBtn = $("sign-out");

      const verifyStatus = $("verify-status");
      const doneStatus = $("done-status");
      const globalStatus = $("global-status");

      const authPill = $("auth-pill");
      const verifiedPill = $("verified-pill");
      const cooldownPill = $("cooldown-pill");

      // ===== INIT =====
      const app = initializeApp(getFirebaseConfig());
      const auth = getAuth(app);

      // ===== COOLDOWN (too-many-requests ë°©ì§€) =====
      const COOLDOWN_KEY = "verify_email_last_send_at";
      let cooldownTimer = null;
      let cooldownSeconds = 60;

      const fmt = (s) => {
        const m = String(Math.floor(s/60)).padStart(2,"0");
        const r = String(s%60).padStart(2,"0");
        return `${m}:${r}`;
      };

      function setPills(){
        const u = auth.currentUser;
        authPill.textContent = u ? "ON" : "OFF";
        verifiedPill.textContent = u ? (u.emailVerified ? "YES" : "NO") : "-";
      }

      function setGlobal(msg, tone="info"){
        globalStatus.innerHTML = msg;
        globalStatus.style.color = tone==="bad" ? "var(--danger)" : tone==="ok" ? "var(--ok)" : "var(--muted)";
      }
      function setVerify(msg, tone="info"){
        verifyStatus.innerHTML = msg;
        verifyStatus.style.color = tone==="bad" ? "var(--danger)" : tone==="ok" ? "var(--ok)" : "var(--muted)";
      }
      function setDone(msg, tone="info"){
        doneStatus.innerHTML = msg;
        doneStatus.style.color = tone==="bad" ? "var(--danger)" : tone==="ok" ? "var(--ok)" : "var(--muted)";
      }

      function startCooldown(seconds){
        clearInterval(cooldownTimer);
        const startedAt = Date.now();
        localStorage.setItem(COOLDOWN_KEY, String(startedAt));
        cooldownSeconds = seconds;

        resendBtn.disabled = true;
        cooldownPill.textContent = fmt(seconds);

        cooldownTimer = setInterval(() => {
          const elapsed = Math.floor((Date.now() - startedAt)/1000);
          const left = Math.max(0, cooldownSeconds - elapsed);
          cooldownPill.textContent = left ? fmt(left) : "0:00";
          if(left <= 0){
            clearInterval(cooldownTimer);
            resendBtn.disabled = !auth.currentUser; // ë¡œê·¸ì¸ ì¤‘ì´ë©´ ì¬ì „ì†¡ ê°€ëŠ¥
          }
        }, 250);
      }

      function resumeCooldownIfAny(){
        const last = Number(localStorage.getItem(COOLDOWN_KEY) || "0");
        if(!last) { cooldownPill.textContent = "-"; return; }
        const elapsed = Math.floor((Date.now() - last)/1000);
        const left = Math.max(0, cooldownSeconds - elapsed);
        if(left > 0) startCooldown(left);
        else cooldownPill.textContent = "0:00";
      }

      // ===== VALIDATION =====
      function validateInputs(){
        const email = emailEl.value.trim();
        const pw = pwEl.value;
        const pw2 = pw2El.value;

        if(!email) return {ok:false, msg:"ì´ë©”ì¼ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”."};
        if(!pw || pw.length < 6) return {ok:false, msg:"ë¹„ë°€ë²ˆí˜¸ëŠ” ìµœì†Œ 6ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤."};
        if(pw !== pw2) return {ok:false, msg:"ë¹„ë°€ë²ˆí˜¸ í™•ì¸ì´ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤."};
        return {ok:true, email, pw};
      }

      // ===== CORE =====
      async function sendVerifyEmail(user){
        // í…œí”Œë¦¿(ì½˜ì†”) ê¸°ë°˜ ì´ë©”ì¼ ì¸ì¦: sendEmailVerification
        // í•„ìš”í•˜ë©´ actionCodeSettingsë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸ URL ì§€ì • ê°€ëŠ¥
        await sendEmailVerification(user);
      }

      async function handleCreateAndSend(){
        const v = validateInputs();
        if(!v.ok){ setGlobal(v.msg, "bad"); return; }

        createSendBtn.disabled = true;

        try{
          // 1) ê³„ì • ìƒì„±
          const cred = await createUserWithEmailAndPassword(auth, v.email, v.pw);

          // 2) ì¸ì¦ë©”ì¼ ì „ì†¡
          await sendVerifyEmail(cred.user);

          setGlobal("ì¸ì¦ë©”ì¼ì„ ë³´ëƒˆì–´ìš”. ë©”ì¼í•¨ì—ì„œ ë§í¬ë¥¼ í´ë¦­í•œ ë’¤, ì•„ë˜ì—ì„œ â€œì¸ì¦ ì™„ë£Œ í™•ì¸â€ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.", "ok");
          setVerify("ë©”ì¼ ì¸ì¦ í›„ ì´ ë²„íŠ¼ì„ ëˆŒëŸ¬ ìƒíƒœë¥¼ í™•ì¸í•´ ì£¼ì„¸ìš”.", "info");
          setDone("ëŒ€ê¸° ì¤‘â€¦ (ì´ë©”ì¼ ì¸ì¦ í•„ìš”)", "info");

          // UI ìƒíƒœ
          checkBtn.disabled = false;
          signOutBtn.disabled = false;
          resendBtn.disabled = true; // ì¿¨ë‹¤ìš´
          startCooldown(60);
          setPills();

        }catch(e){
          const code = e?.code || "";
          if(code === "auth/email-already-in-use"){
            setGlobal("ì´ë¯¸ ê°€ì…ëœ ì´ë©”ì¼ì´ì—ìš”. ë¡œê·¸ì¸ í›„ â€˜ì¸ì¦ë©”ì¼ ì¬ì „ì†¡â€™ìœ¼ë¡œ ì§„í–‰í•´ ì£¼ì„¸ìš”.", "bad");
          }else if(code === "auth/operation-not-allowed"){
            setGlobal("auth/operation-not-allowed: ì½˜ì†”ì—ì„œ Email/Password ì œê³µìê°€ êº¼ì ¸ìˆì„ ê°€ëŠ¥ì„±ì´ ë†’ì•„ìš”. ìš°ì¸¡ ì²´í¬ë¦¬ìŠ¤íŠ¸ 1ë²ˆì„ í™•ì¸í•´ ì£¼ì„¸ìš”.", "bad");
          }else if(code === "auth/too-many-requests"){
            setGlobal("ìš”ì²­ì´ ë„ˆë¬´ ë§ì•„ ì ì‹œ ì°¨ë‹¨ëì–´ìš”. 5ë¶„ ë’¤ ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.", "bad");
            startCooldown(300);
          }else{
            setGlobal(`ì—ëŸ¬: ${code || e?.message || e}`, "bad");
          }
        }finally{
          createSendBtn.disabled = false;
          setPills();
        }
      }

      async function handleResend(){
        const u = auth.currentUser;
        if(!u){
          setGlobal("ì¬ì „ì†¡í•˜ë ¤ë©´ ë¨¼ì € ë¡œê·¸ì¸ ìƒíƒœì—¬ì•¼ í•´ìš”.", "bad");
          return;
        }
        resendBtn.disabled = true;

        try{
          await sendVerifyEmail(u);
          setGlobal("ì¸ì¦ë©”ì¼ì„ ë‹¤ì‹œ ë³´ëƒˆì–´ìš”.", "ok");
          startCooldown(60);
        }catch(e){
          const code = e?.code || "";
          if(code === "auth/too-many-requests"){
            setGlobal("ìš”ì²­ì´ ë„ˆë¬´ ë§ì•„ ì ì‹œ ì°¨ë‹¨ëì–´ìš”. 5ë¶„ ë’¤ ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.", "bad");
            startCooldown(300);
          }else if(code === "auth/operation-not-allowed"){
            setGlobal("auth/operation-not-allowed: ì½˜ì†”ì—ì„œ Email/Password ì œê³µìê°€ êº¼ì ¸ìˆì„ ê°€ëŠ¥ì„±ì´ ë†’ì•„ìš”.", "bad");
          }else{
            setGlobal(`ì¬ì „ì†¡ ì‹¤íŒ¨: ${code || e?.message || e}`, "bad");
          }
        }finally{
          setPills();
        }
      }

      async function handleCheckVerified(){
        const u = auth.currentUser;
        if(!u){
          setVerify("í˜„ì¬ ë¡œê·¸ì¸ ìƒíƒœê°€ ì•„ë‹ˆì—ìš”.", "bad");
          return;
        }
        try{
          await reload(u);
          if(u.emailVerified){
            setVerify("ì´ë©”ì¼ ì¸ì¦ ì™„ë£Œ âœ…", "ok");
            setDone("ê°€ì… ì™„ë£Œ ğŸ‰", "ok");
          }else{
            setVerify("ì•„ì§ ì¸ì¦ì´ ì™„ë£Œë˜ì§€ ì•Šì•˜ì–´ìš”. ë©”ì¼ì˜ ë§í¬ë¥¼ í´ë¦­í–ˆëŠ”ì§€ í™•ì¸í•´ ì£¼ì„¸ìš”.", "bad");
            setDone("ëŒ€ê¸° ì¤‘â€¦ (ì´ë©”ì¼ ì¸ì¦ í•„ìš”)", "info");
          }
        }catch(e){
          setVerify(`í™•ì¸ ì‹¤íŒ¨: ${e?.code || e?.message || e}`, "bad");
        }finally{
          setPills();
          // ì¿¨ë‹¤ìš´ ëë‚¬ê³  ë¡œê·¸ì¸ ì¤‘ì´ë©´ ì¬ì „ì†¡ ê°€ëŠ¥
          if(cooldownPill.textContent === "0:00") resendBtn.disabled = false;
        }
      }

      async function handleSignOut(){
        await signOut(auth);
        setGlobal("ë¡œê·¸ì•„ì›ƒí–ˆì–´ìš”.", "info");
        setVerify("", "info");
        setDone("ì´ë©”ì¼ ì¸ì¦ì´ ì™„ë£Œë˜ë©´ ìë™ìœ¼ë¡œ â€œê°€ì… ì™„ë£Œâ€ ìƒíƒœê°€ ë©ë‹ˆë‹¤.", "info");
        resendBtn.disabled = true;
        checkBtn.disabled = true;
        signOutBtn.disabled = true;
        setPills();
      }

      // ===== Wire up =====
      createSendBtn.addEventListener("click", handleCreateAndSend);
      resendBtn.addEventListener("click", handleResend);
      checkBtn.addEventListener("click", handleCheckVerified);
      signOutBtn.addEventListener("click", handleSignOut);

      // Existing user flow: email already in use â†’ ë¡œê·¸ì¸ í›„ ì¬ì „ì†¡
      emailEl.addEventListener("keydown", async (e) => {
        if(e.key !== "Enter") return;
        // no-op (avoid accidental submits)
      });

      // Resume cooldown UI
      resumeCooldownIfAny();
      setPills();

      // If user is already signed in (e.g. refreshed)
      if(auth.currentUser){
        checkBtn.disabled = false;
        signOutBtn.disabled = false;
        resendBtn.disabled = cooldownPill.textContent !== "0:00";
      }
    </script>
</body>
</html>
