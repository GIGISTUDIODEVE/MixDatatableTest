<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>CombatStats 프리셋 테스트</title>
  <style>
    :root {
      color-scheme: light dark;
      font-family: "Noto Sans KR", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    body {
      margin: 0;
      padding: 1.5rem;
      background: #0f172a;
      color: #e2e8f0;
    }

    h1 {
      margin-top: 0;
    }

    .container {
      display: grid;
      gap: 1rem;
    }

    .card {
      background: #111827;
      border: 1px solid #1f2937;
      border-radius: 12px;
      padding: 1rem 1.25rem;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
    }

    .card h2 {
      margin-top: 0;
      margin-bottom: 0.5rem;
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 0.75rem 1rem;
    }

    label {
      display: block;
      font-weight: 600;
      margin-bottom: 0.35rem;
    }

    input,
    select {
      width: 100%;
      padding: 0.45rem 0.6rem;
      border-radius: 8px;
      border: 1px solid #334155;
      background: #0b1220;
      color: #e2e8f0;
    }

    .actions {
      display: flex;
      gap: 0.75rem;
      flex-wrap: wrap;
      margin-top: 1rem;
    }

    button {
      border: none;
      border-radius: 10px;
      padding: 0.6rem 1rem;
      font-weight: 700;
      cursor: pointer;
      transition: transform 0.1s ease, filter 0.15s ease;
    }

    button.primary {
      background: linear-gradient(90deg, #3b82f6, #06b6d4);
      color: #0b1220;
    }

    button.secondary {
      background: #1f2937;
      color: #e2e8f0;
      border: 1px solid #334155;
    }

    button:hover {
      filter: brightness(1.05);
      transform: translateY(-1px);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 0.5rem;
    }

    th,
    td {
      border-bottom: 1px solid #1f2937;
      padding: 0.6rem;
      text-align: left;
    }

    th {
      color: #cbd5e1;
      font-size: 0.95rem;
    }

    tr:hover td {
      background: #0b1220;
    }

    .status {
      margin-top: 0.75rem;
      padding: 0.6rem 0.8rem;
      border-radius: 10px;
      background: #0b1220;
      border: 1px solid #1f2937;
      color: #cbd5e1;
      min-height: 1.4rem;
      white-space: pre-line;
    }

    .muted {
      color: #94a3b8;
      font-size: 0.9rem;
    }

    .result-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 0.6rem 0.8rem;
    }

    .result-box {
      background: #0b1220;
      border: 1px solid #1f2937;
      border-radius: 10px;
      padding: 0.75rem;
    }

    .result-box .label {
      display: block;
      color: #94a3b8;
      margin-bottom: 0.25rem;
      font-size: 0.9rem;
    }

    .result-box .value {
      font-size: 1.2rem;
      font-weight: 700;
    }

    .stack {
      display: grid;
      gap: 0.35rem;
    }
  </style>
</head>
<body>
  <div class="container">
    <header class="card">
      <h1>CombatStats 프리셋 테스트</h1>
      <p class="muted">CombatStats.md 계산 가이드에 따라 BaseStat/Growth 프리셋을 조합해 기대 피해와 DPS를 검증합니다.</p>
    </header>

    <section class="card">
      <h2>프리셋 선택</h2>
      <div class="grid">
        <div>
          <label for="base-select">BaseStat 프리셋</label>
          <select id="base-select"></select>
          <div class="muted">Firestore: <code>baseStatPresets</code></div>
        </div>
        <div>
          <label for="growth-select">Growth 프리셋</label>
          <select id="growth-select"></select>
          <div class="muted">Firestore: <code>growthBaseStatPresets</code></div>
        </div>
        <div>
          <label for="level-input">레벨</label>
          <input type="number" id="level-input" min="0" value="1" />
        </div>
      </div>
      <div class="actions">
        <button class="primary" id="run-btn">계산 실행</button>
        <button class="secondary" id="reload-btn">프리셋 새로고침</button>
      </div>
      <div class="status" id="status"></div>
    </section>

    <section class="card">
      <h2>계산 상수</h2>
      <div class="grid" id="constant-grid"></div>
      <p class="muted">모든 값은 0 이하로 내려가지 않도록 보정합니다. (CombatStats.md)</p>
    </section>

    <section class="card">
      <h2>선택된 프리셋 미리보기</h2>
      <div class="grid">
        <div>
          <h3>BaseStat 값</h3>
          <table id="base-preview"></table>
        </div>
        <div>
          <h3>Growth 값</h3>
          <table id="growth-preview"></table>
        </div>
      </div>
    </section>

    <section class="card">
      <h2>계산 결과</h2>
      <div class="result-grid" id="result-grid"></div>
    </section>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
    import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";
    import { firebaseConfig } from "./firebase-config.js";

    const statusEl = document.getElementById("status");
    const baseSelect = document.getElementById("base-select");
    const growthSelect = document.getElementById("growth-select");
    const levelInput = document.getElementById("level-input");
    const resultGrid = document.getElementById("result-grid");
    const basePreview = document.getElementById("base-preview");
    const growthPreview = document.getElementById("growth-preview");
    const runBtn = document.getElementById("run-btn");
    const reloadBtn = document.getElementById("reload-btn");
    const constantGrid = document.getElementById("constant-grid");

    let db;
    const collections = {
      base: "baseStatPresets",
      growth: "growthBaseStatPresets",
    };

    const constants = [
      { key: "critChanceMin", label: "critChanceMin", default: 0, min: 0 },
      { key: "critChanceMax", label: "critChanceMax", default: 100, min: 0 },
      { key: "critDamageMin", label: "critDamageMin", default: 1, min: 0 },
      { key: "armorMitigationBase", label: "armorMitigationBase", default: 100, min: 0 },
      { key: "armorMitigationDivisor", label: "armorMitigationDivisor", default: 100, min: 0 },
      { key: "attackSpeedMin", label: "attackSpeedMin", default: 0, min: 0 },
    ];

    const constantInputs = new Map();
    let basePresets = [];
    let growthPresets = [];

    function clampNumber(value, min = 0, max = Number.POSITIVE_INFINITY) {
      const parsed = Number(value);
      if (Number.isNaN(parsed)) return min;
      return Math.min(Math.max(parsed, min), max);
    }

    function setStatus(message, { persist = false } = {}) {
      statusEl.textContent = message;
      if (!persist) {
        setTimeout(() => {
          statusEl.textContent = "";
        }, 5000);
      }
    }

    function buildConstantInputs() {
      constants.forEach(({ key, label, default: def, min }) => {
        const wrapper = document.createElement("div");
        const labelEl = document.createElement("label");
        labelEl.textContent = label;
        const input = document.createElement("input");
        input.type = "number";
        input.min = String(min ?? 0);
        input.value = String(def);
        wrapper.append(labelEl, input);
        constantGrid.appendChild(wrapper);
        constantInputs.set(key, input);
      });
    }

    async function initializeFirestore() {
      try {
        const app = initializeApp(firebaseConfig);
        db = getFirestore(app);
      } catch (error) {
        console.error(error);
        setStatus("Firestore 초기화에 실패했습니다. firebase-config.js를 확인하세요.", { persist: true });
        throw error;
      }
    }

    async function loadCollection(name) {
      const ref = collection(db, name);
      const snapshot = await getDocs(ref);
      const rows = [];
      snapshot.forEach((docSnap) => rows.push({ id: docSnap.id, ...docSnap.data() }));
      return rows;
    }

    function renderOptions(selectEl, presets) {
      selectEl.innerHTML = "";
      const placeholder = document.createElement("option");
      placeholder.value = "";
      placeholder.textContent = "프리셋을 선택하세요";
      selectEl.appendChild(placeholder);
      presets.forEach((preset) => {
        const option = document.createElement("option");
        option.value = preset.id;
        option.textContent = preset.name || preset.id;
        selectEl.appendChild(option);
      });
    }

    function renderPreview(tableEl, preset, fields) {
      tableEl.innerHTML = "";
      const tbody = document.createElement("tbody");
      fields.forEach((field) => {
        const tr = document.createElement("tr");
        const labelTd = document.createElement("td");
        labelTd.textContent = field;
        const valueTd = document.createElement("td");
        valueTd.textContent = preset ? preset[field] ?? "-" : "-";
        tr.append(labelTd, valueTd);
        tbody.appendChild(tr);
      });
      tableEl.appendChild(tbody);
    }

    function getSelectedPreset(selectEl, presets) {
      const id = selectEl.value;
      if (!id) return null;
      return presets.find((preset) => preset.id === id) || null;
    }

    function gatherConstants() {
      const values = {};
      constants.forEach(({ key, min }) => {
        const input = constantInputs.get(key);
        values[key] = clampNumber(input.value, min ?? 0);
      });
      return values;
    }

    function calculateFinal(base, growth, level) {
      const safeLevel = clampNumber(level, 0);
      const stats = {};
      const numericKeys = [
        "hp",
        "hpRegen",
        "ad",
        "ap",
        "as",
        "critChance",
        "critDamage",
        "armor",
        "mr",
        "moveSpeed",
        "range",
        "abilityHaste",
      ];

      numericKeys.forEach((key) => {
        const baseValue = clampNumber(base?.[key] ?? 0, 0);
        const growthValue = clampNumber(growth?.[key] ?? 0, 0);
        stats[key] = baseValue + safeLevel * growthValue;
      });

      stats.Element = base?.Element || growth?.Element || "-";
      stats.level = safeLevel;
      return stats;
    }

    function calculateCombat(stats, constantValues) {
      const {
        critChanceMin,
        critChanceMax,
        critDamageMin,
        armorMitigationBase,
        armorMitigationDivisor,
        attackSpeedMin,
      } = constantValues;

      const critChanceClamped = clampNumber(stats.critChance, critChanceMin, critChanceMax);
      const critDamageClamped = clampNumber(stats.critDamage, critDamageMin);
      const expectedHit = stats.ad * (1 + (critChanceClamped / 100) * (critDamageClamped - 1));
      const mitigation = armorMitigationDivisor + Math.max(stats.armor, 0);
      const mitigationCoeff = mitigation === 0 ? 0 : armorMitigationBase / mitigation;
      const dps = expectedHit * mitigationCoeff * Math.max(stats.as, attackSpeedMin);
      return { critChanceClamped, critDamageClamped, expectedHit, mitigationCoeff, dps };
    }

    function renderResult(stats, combat) {
      resultGrid.innerHTML = "";
      const entries = {
        레벨: stats.level,
        HP: stats.hp,
        "HP Regen": stats.hpRegen,
        AD: stats.ad,
        AP: stats.ap,
        AS: stats.as,
        "Crit Chance (clamped)": combat.critChanceClamped,
        "Crit Damage (clamped)": combat.critDamageClamped,
        Armor: stats.armor,
        "Armor Mitigation": combat.mitigationCoeff.toFixed(4),
        MR: stats.mr,
        "이동속도": stats.moveSpeed,
        "사거리": stats.range,
        "스킬 가속": stats.abilityHaste,
        Element: stats.Element,
        "Expected Hit": combat.expectedHit.toFixed(2),
        DPS: combat.dps.toFixed(2),
      };

      Object.entries(entries).forEach(([label, value]) => {
        const box = document.createElement("div");
        box.className = "result-box";
        const labelEl = document.createElement("span");
        labelEl.className = "label";
        labelEl.textContent = label;
        const valueEl = document.createElement("span");
        valueEl.className = "value";
        valueEl.textContent = value;
        box.append(labelEl, valueEl);
        resultGrid.appendChild(box);
      });
    }

    async function refreshPresets() {
      try {
        setStatus("프리셋을 불러오는 중...", { persist: true });
        basePresets = await loadCollection(collections.base);
        growthPresets = await loadCollection(collections.growth);
        renderOptions(baseSelect, basePresets);
        renderOptions(growthSelect, growthPresets);
        renderPreview(basePreview, null, [
          "hp",
          "hpRegen",
          "ad",
          "ap",
          "as",
          "critChance",
          "critDamage",
          "armor",
          "mr",
          "moveSpeed",
          "range",
          "abilityHaste",
          "Element",
        ]);
        renderPreview(growthPreview, null, ["hp", "ad", "ap", "armor", "mr", "Element"]);
        setStatus(`Base ${basePresets.length}개, Growth ${growthPresets.length}개 프리셋을 불러왔습니다.`);
      } catch (error) {
        console.error(error);
        setStatus("프리셋 불러오기에 실패했습니다. 네트워크와 권한을 확인하세요.", { persist: true });
      }
    }

    function handleSelectionChange() {
      const base = getSelectedPreset(baseSelect, basePresets);
      const growth = getSelectedPreset(growthSelect, growthPresets);
      renderPreview(
        basePreview,
        base,
        [
          "hp",
          "hpRegen",
          "ad",
          "ap",
          "as",
          "critChance",
          "critDamage",
          "armor",
          "mr",
          "moveSpeed",
          "range",
          "abilityHaste",
          "Element",
        ]
      );
      renderPreview(growthPreview, growth, ["hp", "ad", "ap", "armor", "mr", "Element"]);
    }

    function runCalculation() {
      const base = getSelectedPreset(baseSelect, basePresets);
      const growth = getSelectedPreset(growthSelect, growthPresets);
      if (!base || !growth) {
        setStatus("Base/Growth 프리셋을 모두 선택하세요.");
        return;
      }

      const level = levelInput.value;
      const constantValues = gatherConstants();
      const stats = calculateFinal(base, growth, level);
      const combat = calculateCombat(stats, constantValues);
      renderResult(stats, combat);
      setStatus("계산이 완료되었습니다.");
    }

    runBtn.addEventListener("click", () => {
      runBtn.disabled = true;
      try {
        runCalculation();
      } finally {
        runBtn.disabled = false;
      }
    });

    reloadBtn.addEventListener("click", () => {
      reloadBtn.disabled = true;
      refreshPresets().finally(() => {
        reloadBtn.disabled = false;
      });
    });

    baseSelect.addEventListener("change", handleSelectionChange);
    growthSelect.addEventListener("change", handleSelectionChange);

    (async function bootstrap() {
      buildConstantInputs();
      try {
        await initializeFirestore();
        await refreshPresets();
      } catch (error) {
        setStatus("초기화에 실패했습니다. 콘솔 로그를 확인하세요.", { persist: true });
      }
    })();
  </script>
</body>
</html>
