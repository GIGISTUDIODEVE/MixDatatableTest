<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>7일 접속 보상 관리 (Firestore)</title>
  <style>
    :root {
      color-scheme: light dark;
      font-family: "Noto Sans KR", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    body {
      margin: 0;
      padding: 1.5rem;
      background: #0f172a;
      color: #e2e8f0;
    }

    .top-nav {
      position: sticky;
      top: 0;
      z-index: 10;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 1rem;
      padding: 0.9rem 1.5rem;
      margin: -1.5rem -1.5rem 1.25rem;
      background: rgba(11, 18, 32, 0.8);
      backdrop-filter: blur(8px);
      border-bottom: 1px solid #1f2937;
    }

    .nav-brand {
      font-weight: 800;
      letter-spacing: -0.01em;
    }

    .nav-links {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
    }

    .nav-link {
      color: #cbd5e1;
      text-decoration: none;
      padding: 0.45rem 0.8rem;
      border-radius: 10px;
      border: 1px solid transparent;
      transition: background 0.15s ease, border-color 0.15s ease, color 0.15s ease;
    }

    .nav-link:hover {
      background: #111827;
      border-color: #1f2937;
      color: #e2e8f0;
    }

    .nav-link.active {
      background: linear-gradient(90deg, #3b82f6, #06b6d4);
      color: #0b1220;
      border-color: transparent;
    }

    h1 {
      margin-top: 0;
    }

    .container {
      display: grid;
      gap: 1.25rem;
    }

    .card {
      background: #111827;
      border: 1px solid #1f2937;
      border-radius: 12px;
      padding: 1rem 1.25rem;
      box-shadow: 0 12px 28px rgba(0, 0, 0, 0.32);
    }

    .card h2 {
      margin: 0 0 0.5rem;
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 0.85rem 1rem;
    }

    .wide-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
      gap: 0.9rem 1.1rem;
    }

    label {
      display: block;
      font-weight: 700;
      margin-bottom: 0.35rem;
    }

    input[type="text"],
    input[type="number"],
    input[type="datetime-local"],
    select,
    textarea {
      width: 100%;
      padding: 0.55rem 0.65rem;
      border-radius: 10px;
      border: 1px solid #334155;
      background: #0b1220;
      color: #e2e8f0;
      font-family: inherit;
    }

    textarea {
      min-height: 120px;
      resize: vertical;
      line-height: 1.45;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 0.25rem;
    }

    th, td {
      border-bottom: 1px solid #1f2937;
      padding: 0.55rem 0.6rem;
      text-align: left;
    }

    th {
      color: #cbd5e1;
      font-size: 0.95rem;
    }

    tr:hover td {
      background: #0b1220;
    }

    .actions {
      display: flex;
      gap: 0.65rem;
      flex-wrap: wrap;
      margin-top: 0.75rem;
    }

    button {
      border: none;
      border-radius: 10px;
      padding: 0.65rem 1.05rem;
      font-weight: 800;
      cursor: pointer;
      transition: transform 0.1s ease, filter 0.15s ease;
    }

    button.primary {
      background: linear-gradient(90deg, #3b82f6, #06b6d4);
      color: #0b1220;
    }

    button.secondary {
      background: #1f2937;
      color: #e2e8f0;
      border: 1px solid #334155;
    }

    button.danger {
      background: #ef4444;
      color: #0b1220;
    }

    button:hover {
      filter: brightness(1.05);
      transform: translateY(-1px);
    }

    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }

    .pill {
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
      padding: 0.35rem 0.55rem;
      border-radius: 999px;
      background: #0b1220;
      border: 1px solid #1f2937;
      color: #cbd5e1;
      font-size: 0.95rem;
      margin-top: 0.35rem;
    }

    .pill.solid {
      background: linear-gradient(90deg, #3b82f6, #06b6d4);
      color: #0b1220;
      border-color: transparent;
      font-weight: 800;
    }

    .status {
      margin-top: 0.8rem;
      padding: 0.7rem 0.85rem;
      border-radius: 10px;
      background: #0b1220;
      border: 1px solid #1f2937;
    }

    .status strong {
      color: #a5b4fc;
    }

    .muted {
      color: #cbd5e1;
      margin-top: 0.35rem;
      line-height: 1.55;
    }

    .preview {
      background: #0b1220;
      border-radius: 10px;
      padding: 0.75rem 0.9rem;
      border: 1px solid #1f2937;
      overflow: auto;
      max-height: 400px;
    }
  </style>
</head>
<body>
  <nav class="top-nav">
    <div class="nav-brand">Stat 관리 도구</div>
    <div class="nav-links">
      <a class="nav-link" href="base-stats-firestore.html">BaseStat 프리셋</a>
      <a class="nav-link" href="growth-base-stats-firestore.html">GrowthBaseStat 프리셋</a>
      <a class="nav-link" href="combat-stats-firestore.html">CombatStats 관리</a>
      <a class="nav-link" href="combat-dps-tester.html">Combat DPS 테스트</a>
      <a class="nav-link" href="effect-system-firestore.html">EffectSpec 관리</a>
      <a class="nav-link" href="monster-firestore.html">몬스터 관리</a>
      <a class="nav-link" href="economy-firestore.html">재화/티어 관리</a>
      <a class="nav-link" href="item-firestore.html">아이템 관리</a>
      <a class="nav-link active" href="login-reward-firestore.html">7일 접속 보상</a>
    </div>
  </nav>

  <div class="container">
    <header class="card">
      <h1>7일 접속 보상 관리</h1>
      <p class="muted">Firestore 컬렉션 <code>loginRewardEvents</code>에 7일 접속 보상 구성을 저장/불러오기/수정/삭제합니다. 안정성을 위해 7개 일자 모두를 검증하고, 잘못된 값은 안전한 기본값으로 보정합니다.</p>
      <div class="pill">핵심 필드: docId · title · active · startAt/endAt · resetCycleDays(기본 7) · rewards[day, rewardType, rewardKey, amount, name, note]</div>
      <div class="pill">저장 시 <code>updatedAt</code> ISO 타임스탬프가 자동 기록됩니다.</div>
    </header>

    <section class="card">
      <h2>문서 불러오기/선택</h2>
      <p class="muted">Firestore에 저장된 보상 구성을 선택해서 불러오거나 새 문서를 생성할 수 있습니다.</p>
      <div class="wide-grid" style="align-items: end;">
        <div>
          <label for="event-select">저장된 문서</label>
          <select id="event-select"></select>
          <div class="muted">문서 ID가 필요하면 먼저 불러오세요.</div>
        </div>
        <div class="actions" style="margin: 0;">
          <button class="secondary" id="refresh-list-btn">목록 새로고침</button>
          <button class="secondary" id="load-selected-btn">선택 불러오기</button>
          <button class="secondary" id="new-empty-btn">새 문서 초기화</button>
        </div>
      </div>
    </section>

    <section class="card">
      <h2>보상 구성</h2>
      <div class="grid">
        <div>
          <label for="doc-id">문서 ID (필수)</label>
          <input id="doc-id" type="text" placeholder="예: weekly-login-2024-11" />
        </div>
        <div>
          <label for="title">제목</label>
          <input id="title" type="text" placeholder="예: 11월 1주차 접속 보상" />
        </div>
        <div>
          <label for="is-active">활성화</label>
          <select id="is-active">
            <option value="true">활성</option>
            <option value="false">비활성</option>
          </select>
        </div>
        <div>
          <label for="reset-cycle">리셋 주기(일)</label>
          <input id="reset-cycle" type="number" min="1" value="7" />
        </div>
        <div>
          <label for="start-at">시작 시각 (선택)</label>
          <input id="start-at" type="datetime-local" />
        </div>
        <div>
          <label for="end-at">종료 시각 (선택)</label>
          <input id="end-at" type="datetime-local" />
        </div>
      </div>
      <div style="margin-top: 0.85rem;">
        <label for="description">설명/메모 (선택)</label>
        <textarea id="description" placeholder="운영용 메모 또는 노출용 문구를 입력하세요."></textarea>
      </div>

      <div class="actions">
        <button class="secondary" id="fill-preset-btn">보상 예시 채우기</button>
        <button class="secondary" id="reset-form-btn">폼 초기화</button>
      </div>

      <div style="margin-top: 1rem;">
        <h3 style="margin: 0 0 0.35rem;">일차별 보상 (7개 모두 필수)</h3>
        <div class="muted">각 일차는 최소 1개 수량을 요구하며, 비어 있는 값은 저장 전에 기본값으로 대체됩니다.</div>
        <table>
          <thead>
            <tr>
              <th style="width: 60px;">일차</th>
              <th style="width: 140px;">보상 타입</th>
              <th>보상 키/코드</th>
              <th>보상 이름</th>
              <th style="width: 120px;">수량</th>
              <th>비고</th>
            </tr>
          </thead>
          <tbody id="reward-rows"></tbody>
        </table>
      </div>

      <div class="actions">
        <button class="primary" id="save-btn">저장/업데이트</button>
        <button class="secondary" id="load-btn">문서 불러오기</button>
        <button class="danger" id="delete-btn">문서 삭제</button>
      </div>

      <div class="status" id="status">준비됨. Firestore 구성이 올바른지 확인하세요.</div>
    </section>

    <section class="card">
      <h2>저장될 JSON 미리보기</h2>
      <pre class="preview" id="preview-json">{ }</pre>
    </section>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
    import {
      getFirestore,
      collection,
      getDocs,
      getDoc,
      setDoc,
      deleteDoc,
      doc,
    } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";
    import { getFirebaseConfig } from "./firebase-config.js";

    const app = initializeApp(await getFirebaseConfig());
    const db = getFirestore(app);
    const eventsRef = collection(db, "loginRewardEvents");

    const elements = {
      docId: document.getElementById("doc-id"),
      title: document.getElementById("title"),
      description: document.getElementById("description"),
      isActive: document.getElementById("is-active"),
      resetCycle: document.getElementById("reset-cycle"),
      startAt: document.getElementById("start-at"),
      endAt: document.getElementById("end-at"),
      rewardRows: document.getElementById("reward-rows"),
      status: document.getElementById("status"),
      preview: document.getElementById("preview-json"),
      fillPreset: document.getElementById("fill-preset-btn"),
      resetForm: document.getElementById("reset-form-btn"),
      saveBtn: document.getElementById("save-btn"),
      loadBtn: document.getElementById("load-btn"),
      deleteBtn: document.getElementById("delete-btn"),
      eventSelect: document.getElementById("event-select"),
      refreshListBtn: document.getElementById("refresh-list-btn"),
      loadSelectedBtn: document.getElementById("load-selected-btn"),
      newEmptyBtn: document.getElementById("new-empty-btn"),
    };

    const rewardTypeOptions = [
      { value: "item", label: "아이템" },
      { value: "currency", label: "재화" },
      { value: "lootBox", label: "상자/선택권" },
      { value: "cosmetic", label: "코스튬/스킨" },
      { value: "other", label: "기타" },
    ];

    let rewardsState = Array.from({ length: 7 }, (_, idx) => createDefaultReward(idx + 1));

    function createDefaultReward(day) {
      return {
        day,
        rewardType: "item",
        rewardKey: "",
        name: "",
        amount: 1,
        note: "",
      };
    }

    function setStatus(message, tone = "info") {
      const colors = {
        info: "#a5b4fc",
        success: "#34d399",
        warning: "#fbbf24",
        error: "#f87171",
      };
      elements.status.innerHTML = `<strong style="color:${colors[tone] ?? colors.info}">${tone.toUpperCase()}</strong> ${message}`;
    }

    function clampNumber(value, min = 1) {
      const parsed = Number(value);
      if (Number.isNaN(parsed)) return min;
      return Math.max(parsed, min);
    }

    function normalizeRewards(rawRewards = []) {
      const map = new Map();
      rawRewards.forEach((entry) => {
        if (!entry) return;
        const day = clampNumber(entry.day, 1);
        if (day > 7) return;
        map.set(day, {
          day,
          rewardType: entry.rewardType || "item",
          rewardKey: typeof entry.rewardKey === "string" ? entry.rewardKey : "",
          name: typeof entry.name === "string" ? entry.name : "",
          amount: clampNumber(entry.amount, 1),
          note: typeof entry.note === "string" ? entry.note : "",
        });
      });

      const normalized = [];
      for (let i = 1; i <= 7; i += 1) {
        normalized.push(map.get(i) ?? createDefaultReward(i));
      }
      return normalized;
    }

    function renderRewards() {
      elements.rewardRows.innerHTML = "";
      rewardsState.forEach((reward) => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>Day ${reward.day}</td>
          <td>
            <select data-day="${reward.day}" data-field="rewardType"></select>
          </td>
          <td>
            <input type="text" data-day="${reward.day}" data-field="rewardKey" placeholder="예: item_sword_001" />
          </td>
          <td>
            <input type="text" data-day="${reward.day}" data-field="name" placeholder="보상 이름" />
          </td>
          <td>
            <input type="number" min="1" data-day="${reward.day}" data-field="amount" />
          </td>
          <td>
            <input type="text" data-day="${reward.day}" data-field="note" placeholder="선택 입력" />
          </td>
        `;
        const select = tr.querySelector("select");
        rewardTypeOptions.forEach((opt) => {
          const option = document.createElement("option");
          option.value = opt.value;
          option.textContent = opt.label;
          select.appendChild(option);
        });
        elements.rewardRows.appendChild(tr);
      });

      updateRewardInputs();
    }

    function updateRewardInputs() {
      rewardsState.forEach((reward) => {
        const inputs = elements.rewardRows.querySelectorAll(`[data-day="${reward.day}"]`);
        inputs.forEach((input) => {
          const field = input.dataset.field;
          if (!field) return;
          if (field === "rewardType") {
            input.value = reward.rewardType;
          } else if (field === "amount") {
            input.value = reward.amount;
          } else {
            input.value = reward[field] ?? "";
          }
        });
      });
    }

    function attachRewardListeners() {
      elements.rewardRows.addEventListener("input", (event) => {
        const target = event.target;
        const day = Number(target.dataset.day);
        const field = target.dataset.field;
        if (!day || !field) return;

        const idx = rewardsState.findIndex((r) => r.day === day);
        if (idx === -1) return;

        const updated = { ...rewardsState[idx] };
        if (field === "amount") {
          updated.amount = clampNumber(target.value, 1);
          target.value = String(updated.amount);
        } else if (field === "rewardType") {
          updated.rewardType = target.value || "item";
        } else {
          updated[field] = target.value.trim();
        }

        rewardsState[idx] = updated;
        updatePreview();
      });
    }

    function readForm() {
      const docId = elements.docId.value.trim();
      const resetCycle = clampNumber(elements.resetCycle.value || "7", 1);
      const startAt = elements.startAt.value ? new Date(elements.startAt.value).toISOString() : null;
      const endAt = elements.endAt.value ? new Date(elements.endAt.value).toISOString() : null;

      return {
        docId,
        title: elements.title.value.trim(),
        description: elements.description.value.trim(),
        active: elements.isActive.value === "true",
        resetCycleDays: resetCycle,
        startAt,
        endAt,
        rewards: normalizeRewards(rewardsState),
      };
    }

    function updatePreview() {
      const data = readForm();
      const payload = buildPayload(data);
      elements.preview.textContent = JSON.stringify(payload, null, 2);
    }

    function buildPayload(formState) {
      return {
        title: formState.title || "무제 보상",
        description: formState.description || "",
        active: Boolean(formState.active),
        resetCycleDays: clampNumber(formState.resetCycleDays, 1),
        startAt: formState.startAt,
        endAt: formState.endAt,
        rewards: normalizeRewards(formState.rewards),
        updatedAt: new Date().toISOString(),
        version: 1,
      };
    }

    function applyDataToForm(docId, data) {
      elements.docId.value = docId;
      elements.title.value = data.title ?? "";
      elements.description.value = data.description ?? "";
      elements.isActive.value = String(Boolean(data.active));
      elements.resetCycle.value = data.resetCycleDays ?? 7;
      elements.startAt.value = data.startAt ? toLocalDateTime(data.startAt) : "";
      elements.endAt.value = data.endAt ? toLocalDateTime(data.endAt) : "";
      rewardsState = normalizeRewards(data.rewards);
      updateRewardInputs();
      updatePreview();
    }

    function toLocalDateTime(value) {
      const date = new Date(value);
      if (Number.isNaN(date.getTime())) return "";
      const tzOffset = date.getTimezoneOffset() * 60000;
      const local = new Date(date.getTime() - tzOffset);
      return local.toISOString().slice(0, 16);
    }

    async function refreshList() {
      try {
        setStatus("문서 목록을 불러오는 중...");
        elements.eventSelect.innerHTML = "";
        const snapshot = await getDocs(eventsRef);
        const docs = snapshot.docs.map((d) => d.id).sort();
        if (docs.length === 0) {
          elements.eventSelect.innerHTML = `<option value="">문서 없음</option>`;
          setStatus("저장된 문서가 없습니다. 새로 작성하세요.", "warning");
          return;
        }
        docs.forEach((id) => {
          const option = document.createElement("option");
          option.value = id;
          option.textContent = id;
          elements.eventSelect.appendChild(option);
        });
        setStatus(`문서 ${docs.length}건을 불러왔습니다.`, "success");
      } catch (error) {
        console.error(error);
        setStatus(`목록 불러오기 실패: ${error?.message ?? error}`, "error");
      }
    }

    async function loadDocument(docId) {
      if (!docId) {
        setStatus("문서 ID를 입력하세요.", "warning");
        return;
      }
      try {
        setStatus(`문서(${docId}) 불러오는 중...`);
        const docRef = doc(eventsRef, docId);
        const snapshot = await getDoc(docRef);
        if (!snapshot.exists()) {
          setStatus("문서를 찾을 수 없습니다.", "error");
          return;
        }
        applyDataToForm(docId, snapshot.data());
        setStatus(`문서(${docId}) 불러오기 완료`, "success");
      } catch (error) {
        console.error(error);
        setStatus(`불러오기 실패: ${error?.message ?? error}`, "error");
      }
    }

    async function saveDocument() {
      const form = readForm();
      if (!form.docId) {
        setStatus("문서 ID를 입력해야 저장할 수 있습니다.", "error");
        return;
      }
      const payload = buildPayload(form);
      try {
        setStatus("저장 중...");
        await setDoc(doc(eventsRef, form.docId), payload);
        setStatus(`저장 완료: ${form.docId}`, "success");
        await refreshList();
      } catch (error) {
        console.error(error);
        setStatus(`저장 실패: ${error?.message ?? error}`, "error");
      }
    }

    async function deleteDocument() {
      const docId = elements.docId.value.trim();
      if (!docId) {
        setStatus("삭제하려면 문서 ID가 필요합니다.", "warning");
        return;
      }
      try {
        setStatus("삭제 중...");
        await deleteDoc(doc(eventsRef, docId));
        setStatus(`삭제 완료: ${docId}`, "success");
        await refreshList();
      } catch (error) {
        console.error(error);
        setStatus(`삭제 실패: ${error?.message ?? error}`, "error");
      }
    }

    function resetForm() {
      elements.docId.value = "";
      elements.title.value = "";
      elements.description.value = "";
      elements.isActive.value = "true";
      elements.resetCycle.value = "7";
      elements.startAt.value = "";
      elements.endAt.value = "";
      rewardsState = Array.from({ length: 7 }, (_, idx) => createDefaultReward(idx + 1));
      updateRewardInputs();
      updatePreview();
      setStatus("폼을 초기화했습니다.");
    }

    function fillPreset() {
      const preset = [
        { rewardType: "currency", rewardKey: "gold", name: "골드", amount: 500 },
        { rewardType: "currency", rewardKey: "gem", name: "젬", amount: 50 },
        { rewardType: "item", rewardKey: "potion_hp_small", name: "소형 회복 물약", amount: 5 },
        { rewardType: "item", rewardKey: "potion_mp_small", name: "소형 마나 물약", amount: 5 },
        { rewardType: "lootBox", rewardKey: "rare_box", name: "희귀 상자", amount: 1 },
        { rewardType: "cosmetic", rewardKey: "avatar_frame_blue", name: "아바타 프레임", amount: 1 },
        { rewardType: "item", rewardKey: "buff_ticket_3d", name: "3일 접속 버프 티켓", amount: 1 },
      ];
      rewardsState = normalizeRewards(
        preset.map((entry, idx) => ({ ...entry, day: idx + 1 }))
      );
      updateRewardInputs();
      updatePreview();
      setStatus("예시 보상으로 채웠습니다.");
    }

    function wireEvents() {
      elements.saveBtn.addEventListener("click", saveDocument);
      elements.loadBtn.addEventListener("click", () => loadDocument(elements.docId.value.trim()));
      elements.deleteBtn.addEventListener("click", deleteDocument);
      elements.fillPreset.addEventListener("click", fillPreset);
      elements.resetForm.addEventListener("click", resetForm);
      elements.refreshListBtn.addEventListener("click", refreshList);
      elements.loadSelectedBtn.addEventListener("click", () => {
        const selected = elements.eventSelect.value;
        if (selected) {
          loadDocument(selected);
        } else {
          setStatus("불러올 문서를 선택하세요.", "warning");
        }
      });
      elements.newEmptyBtn.addEventListener("click", resetForm);
      ["docId", "title", "description", "isActive", "resetCycle", "startAt", "endAt"].forEach((key) => {
        const el = elements[key];
        if (el) {
          el.addEventListener("input", updatePreview);
          el.addEventListener("change", updatePreview);
        }
      });
    }

    function setInitialDocId() {
      const now = new Date();
      const isoDate = now.toISOString().slice(0, 10);
      elements.docId.placeholder = `login-${isoDate}`;
    }

    renderRewards();
    attachRewardListeners();
    wireEvents();
    setInitialDocId();
    updatePreview();
    refreshList();
  </script>
</body>
</html>
